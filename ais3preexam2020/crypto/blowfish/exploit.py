import pwn
import pdb
from base64 import b64encode as e64
from base64 import b64decode as d64

# command: python -m pickletools user.pickle
# command: python -m pickle user.pickle
# in user.pickle:
#  [{'admin': False, 'name': 'maojui', 'password': 'SECRET'},
#  {'admin': False, 'name': 'djosix', 'password': 'S3crE7'},
#  {'admin': False, 'name': 'kaibro', 'password': 'GGInIn'},
#  {'admin': False, 'name': 'others', 'password': '_FLAG_'}]]

pwn.context(log_level='debug')

y = pwn.remote('localhost', 7777)

y.recvuntil('Your token: ')
token = y.recvline().strip(b'\n')

# bit flipping attack (CTR)
token = bytearray(d64(token))
token[0xbc] ^= 1  # admin: False(0x89) -> True(0x88)
token = e64(token)

y.recvuntil('username : ')
y.sendline('others')

y.recvuntil('password : ')
y.sendline('_FLAG_')

y.recvuntil('TOKEN : ')
y.sendline(token)

y.recv()
